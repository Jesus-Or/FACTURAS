<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard de Facturas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 20px;
        }
        .sticky-wrapper {
            position: sticky; top: 0; z-index: 1002;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding-top: 20px;
            margin: -20px -20px 0 -20px;
            padding-left: 20px; padding-right: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        .header {
            position: relative; z-index: 1001; background: white;
            padding: 15px 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px;
            text-align: center; transition: box-shadow 0.3s ease;
        }
        .header.scrolled { box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .header h1 { color: #667eea; font-size: 1.5em; margin-bottom: 0; }
        .header p { color: #666; font-size: 0.9em; }

        .search-container {
            position: relative; z-index: 1000; background: white;
            padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px; transition: box-shadow 0.3s ease;
        }
        .search-container.scrolled { box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .search-box { margin-bottom: 15px; }
        #searchInput {
            width: 100%; padding: 15px 20px; font-size: 1.1em; border: 2px solid #e0e0e0;
            border-radius: 10px; transition: all 0.3s ease; font-family: inherit;
        }
        #searchInput:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }

        .filter-buttons { display:flex; gap:10px; flex-wrap:wrap; }
        .filter-buttons select { flex:1; min-width:150px; padding:12px 15px; font-size:1em; border:2px solid #e0e0e0; border-radius:10px; background:white; cursor:pointer; transition:all 0.3s ease; font-family:inherit; }
        .clear-btn { padding:12px 25px; background:#f5f5f5; border:2px solid #e0e0e0; border-radius:10px; cursor:pointer; font-weight:bold; font-size:1em; transition:all 0.3s ease; font-family:inherit; }
        .clear-btn:hover { background:#667eea; color:white; border-color:#667eea; }

        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { background:white; padding:25px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); text-align:center; transition:transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { color:#666; font-size:0.9em; text-transform:uppercase; margin-bottom:10px; }
        .stat-card .number { font-size:2.5em; font-weight:bold; color:#667eea; }

        .comparison-card { background:white; border-radius:15px; padding:25px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); transition:all 0.3s ease; }
        .comparison-card:hover { box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .comparison-card.hidden { display:none; }

        .service-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #f0f0f0; }
        .service-name { font-size:1.3em; font-weight:bold; color:#333; flex:1; }
        .status-badge { padding:8px 20px; border-radius:25px; font-weight:bold; font-size:0.9em; text-transform:uppercase; letter-spacing:1px; }
        .status-badge.status-subio { background:#ffebee; color:#c62828; }
        .status-badge.status-bajo { background:#e8f5e9; color:#2e7d32; }
        .status-badge.status-estable { background:#fff3e0; color:#ef6c00; }

        .comparison-details { display:grid; grid-template-columns:1fr auto 1fr; gap:30px; align-items:start; }
        .month-box { background:#f8f9fa; padding:20px; border-radius:10px; }
        .month-label { color:#666; font-size:0.9em; margin-bottom:5px; text-transform:uppercase; text-align:center; }
        .month-date { font-size:1.1em; font-weight:bold; color:#333; margin-bottom:10px; text-align:center; }
        .month-amount { font-size:1.8em; font-weight:bold; color:#667eea; text-align:center; margin-bottom:10px; }
        .month-invoices { text-align:center; font-size:0.85em; color:#888; margin-bottom:15px; }
        .arrow-container { text-align:center; padding-top:40px; }
        .arrow { font-size:3em; font-weight:bold; }
        .arrow.up { color:#c62828; } .arrow.down { color:#2e7d32; } .arrow.stable { color:#ef6c00; }

        .difference { margin-top:10px; font-weight:bold; }
        .difference-amount { font-size:1.2em; }
        .difference-percent { font-size:0.9em; color:#666; margin-top:5px; }

        .invoice-details { margin-top:15px; padding-top:15px; border-top:1px solid #e0e0e0; }
        .invoice-item { background:white; padding:12px; margin-bottom:10px; border-radius:8px; border-left:4px solid #667eea; transition:all 0.3s ease; cursor:pointer; position:relative; }
        .invoice-item:hover { transform: translateX(5px); box-shadow:0 2px 8px rgba(0,0,0,0.1); border-left-color:#764ba2; }
        .invoice-item::after { content:"üëÅÔ∏è Ver detalles"; position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:0.8em; color:#667eea; opacity:0; transition:opacity 0.3s ease; }
        .invoice-item:hover::after { opacity:1; }

        .invoice-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .invoice-number { font-weight:bold; color:#667eea; font-size:0.95em; }
        .invoice-amount { font-weight:bold; color:#333; font-size:1.1em; }
        .invoice-date { font-size:0.85em; color:#888; display:flex; align-items:center; gap:5px; }
        .invoice-date::before { content: "üìÖ"; }

        .invoices-title { font-size:0.9em; font-weight:bold; color:#555; margin-bottom:10px; text-transform:uppercase; letter-spacing:0.5px; }
        .total-summary { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:12px; border-radius:8px; margin-top:10px; text-align:center; font-weight:bold; }

        .service-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; animation:fadeIn 0.2s ease; }
        .service-modal.active { display:flex; justify-content:center; align-items:center; padding:20px; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .modal-content { background:white; border-radius:15px; padding:30px; max-width:800px; width:100%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:slideUp 0.3s ease; position:relative; }
        @keyframes slideUp { from{ transform:translateY(50px); opacity:0 } to{ transform:translateY(0); opacity:1 } }

        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #f0f0f0; }
        .modal-title { font-size:1.5em; font-weight:bold; color:#667eea; }
        .modal-close { background:#f5f5f5; border:none; width:35px; height:35px; border-radius:50%; font-size:1.5em; cursor:pointer; transition:all 0.3s ease; display:flex; align-items:center; justify-content:center; }
        .modal-close:hover { background:#667eea; color:white; transform:rotate(90deg); }

        .modal-invoice-info { background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px; }
        .modal-info-row { display:flex; justify-content:space-between; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #e0e0e0; }
        .modal-info-row:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0; }
        .modal-info-label { font-weight:bold; color:#666; }
        .modal-info-value { color:#333; }

        .modal-services-title { font-size:1.2em; font-weight:bold; color:#333; margin-bottom:15px; display:flex; align-items:center; gap:10px; }
        .modal-services-title::before { content:"üìã"; }

        .modal-total { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:15px; border-radius:10px; margin-top:20px; text-align:center; }
        .modal-total-label { font-size:0.9em; margin-bottom:5px; opacity:0.9; }
        .modal-total-amount { font-size:1.8em; font-weight:bold; }

        .no-data, .no-results { text-align:center; padding:50px; color:#666; background:white; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-top:20px; }
        .no-results { display:none; }
        .no-results h2 { color:#667eea; margin-bottom:10px; }

        @media (max-width:768px) {
            .comparison-details { grid-template-columns:1fr; gap:20px; }
            .arrow-container { transform:rotate(90deg); padding-top:20px; }
            .header h1 { font-size:1.3em; }
            .stat-card .number { font-size:2em; }
            .invoice-header { flex-direction:column; align-items:flex-start; gap:5px; }
            .filter-buttons { flex-direction:column; }
            .filter-buttons select, .clear-btn { width:100%; }
            .modal-content { padding:20px; max-height:90vh; }
            .invoice-item::after { display:none; }
        }
    </style>
</head>
<body>
    <!-- MODAL -->
    <div class="service-modal" id="serviceModal">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Detalle de Factura</div>
                <button class="modal-close" id="modalClose" aria-label="Cerrar modal">√ó</button>
            </div>

            <div class="modal-invoice-info" id="modalInvoiceInfo"></div>
            <div class="modal-services-title">Servicios Incluidos</div>
            <div id="modalServicesContainer"></div>

            <div class="modal-total">
                <div class="modal-total-label">Total de la Factura</div>
                <div class="modal-total-amount" id="modalTotalAmount">0</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sticky-wrapper">
            <div class="header rounded p-3">
                <div class="d-flex align-items-center">
                    <img src="/img/Securitas-logo-light.jpeg" alt="Logo Securitas" style="width:150px; margin-right:8px;">
                    <span class="fw-bold" style="font-size:1.2rem;">Securitas Colombia</span>
                </div>

                <div class="text-center mt-2">
                    <h1 class="m-0" style="color:#667eea;">Dashboard de Facturas</h1>
                    <p class="m-0 text-secondary">An√°lisis comparativo mes a mes por servicio</p>
                </div>
            </div>

            <!-- FILTROS -->
            <div class="search-container" id="searchContainer">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Buscar por servicio o n√∫mero de factura...">
                </div>
                <div class="filter-buttons">
                    <select id="yearFilter">
                        <option value="">Todos los a√±os</option>
                    </select>
                    <select id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="subio">‚Üó Aument√≥</option>
                        <option value="bajo">‚Üò Disminuy√≥</option>
                        <option value="estable">‚Üí Estable</option>
                    </select>
                    <button id="clearFilters" class="clear-btn">Limpiar filtros</button>
                </div>
            </div>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Comparaciones</h3>
                <div class="number" id="totalComparaciones">0</div>
            </div>
            <div class="stat-card">
                <h3>Servicios Activos</h3>
                <div class="number" id="serviciosActivos">0</div>
            </div>
            <div class="stat-card">
                <h3>Aumentos</h3>
                <div class="number" style="color:#c62828;" id="totalAumentos">0</div>
            </div>
            <div class="stat-card">
                <h3>Reducciones</h3>
                <div class="number" style="color:#2e7d32;" id="totalReducciones">0</div>
            </div>
        </div>

        <!-- CONTENEDOR DE COMPARACIONES -->
        <div id="comparacionesContainer"></div>

        <!-- MENSAJE SIN RESULTADOS -->
        <div class="no-results" id="noResults">
            <h2>üîç No se encontraron resultados</h2>
            <p>Intenta ajustar los filtros o realiza una b√∫squeda diferente.</p>
        </div>
    </div>

    <script>
        // ===========================
        // Datos (desde servidor EJS)
        // ===========================
        const comparacionesData = <%- JSON.stringify(comparaciones || []) %>;

        // ===========================
        // Helpers de formato
        // ===========================
        function formatCurrency(value) {
            const n = Number(value) || 0;
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 4
            }).format(n);
        }

        function formatCurrencyCO(valor) {
            const n = Number(valor) || 0;
            const partes = n.toFixed(2).split('.');
            let entero = partes[0];
            const decimales = partes[1];
            entero = entero.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            return `${entero},${decimales}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Fecha inv√°lida';
            return date.toLocaleDateString('es-CO', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        function encodeFactura(f) {
            return encodeURIComponent(JSON.stringify(f));
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ===========================
        // Renderizado
        // ===========================
        function renderComparaciones(datos) {
            const container = document.getElementById('comparacionesContainer');

            if (!datos || datos.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h2>No hay datos para mostrar</h2>
                        <p>Sube facturas PDF para ver las comparaciones mes a mes.</p>
                    </div>
                `;
                actualizarEstadisticas([]);
                return;
            }

            container.innerHTML = datos.map(comp => `
                <div class="comparison-card">
                    <div class="service-header">
                        <div class="service-name">${comp.servicio}</div>
                        <div class="status-badge status-${comp.estado}">
                            ${comp.estado === 'subio' ? '‚Üó Aument√≥' : comp.estado === 'bajo' ? '‚Üò Disminuy√≥' : '‚Üí Estable'}
                        </div>
                    </div>

                    <div class="comparison-details">
                        <div class="month-box">
                            <div class="month-label">Mes Anterior</div>
                            <div class="month-date">${comp.mesAnterior}</div>
                            <div class="month-amount">$${formatCurrency(comp.montoAnterior)}</div>
                            <div class="month-invoices">${comp.cantidadAnterior} factura(s)</div>
                            <div class="invoice-details">
                                <div class="invoices-title">üìÑ Detalle de Facturas</div>
                                ${ (comp.facturasAnterior || []).map(f => `
                                    <div class="invoice-item" data-factura='${encodeFactura({
                                        numero: f.numero,
                                        fecha: f.fecha,
                                        monto: f.monto,
                                        descripcion: f.descripcion || null,
                                        Cliente: f.Cliente || null
                                    })}'>
                                        <div class="invoice-header">
                                            <span class="invoice-number">#${f.numero}</span>
                                            <span class="invoice-amount">$${formatCurrency(f.monto)}</span>
                                        </div>
                                        <div class="invoice-date">${formatDate(f.fecha)}</div>
                                    </div>
                                `).join('')}
                                <div class="total-summary">Total: $${formatCurrency(comp.montoAnterior)}</div>
                            </div>
                        </div>

                        <div class="arrow-container">
                            <div class="arrow ${comp.estado === 'subio' ? 'up' : comp.estado === 'bajo' ? 'down' : 'stable'}">
                                ${comp.estado === 'subio' ? '‚Üó' : comp.estado === 'bajo' ? '‚Üò' : '‚Üí'}
                            </div>
                            <div class="difference">
                                <div class="difference-amount" style="color: ${comp.estado === 'subio' ? '#c62828' : comp.estado === 'bajo' ? '#2e7d32' : '#ef6c00'}">
                                    ${comp.diferencia >= 0 ? '+' : ''}$${formatCurrency(Math.abs(comp.diferencia))}
                                </div>
                                <div class="difference-percent">
                                    (${comp.porcentaje >= 0 ? '+' : ''}${(comp.porcentaje || 0).toFixed(2)}%)
                                </div>
                            </div>
                        </div>

                        <div class="month-box">
                            <div class="month-label">Mes Actual</div>
                            <div class="month-date">${comp.mesActual}</div>
                            <div class="month-amount">$${formatCurrency(comp.montoActual)}</div>
                            <div class="month-invoices">${comp.cantidadActual} factura(s)</div>
                            <div class="invoice-details">
                                <div class="invoices-title">üìÑ Detalle de Facturas</div>
                                ${ (comp.facturasActual || []).map(f => `
                                    <div class="invoice-item" data-factura='${encodeFactura({
                                        numero: f.numero,
                                        fecha: f.fecha,
                                        monto: f.monto,
                                        descripcion: f.descripcion || null,
                                        Cliente: f.Cliente || null
                                    })}'>
                                        <div class="invoice-header">
                                            <span class="invoice-number">#${f.numero}</span>
                                            <span class="invoice-amount">$${formatCurrency(f.monto)}</span>
                                        </div>
                                        <div class="invoice-date">${formatDate(f.fecha)}</div>
                                    </div>
                                `).join('')}
                                <div class="total-summary">Total: $${formatCurrency(comp.montoActual)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            actualizarEstadisticas(datos);
        }

        function actualizarEstadisticas(datos) {
            const servicios = new Set((datos || []).map(d => d.servicio));
            const aumentos = (datos || []).filter(d => d.estado === 'subio').length;
            const reducciones = (datos || []).filter(d => d.estado === 'bajo').length;

            document.getElementById('totalComparaciones').textContent = (datos || []).length;
            document.getElementById('serviciosActivos').textContent = servicios.size;
            document.getElementById('totalAumentos').textContent = aumentos;
            document.getElementById('totalReducciones').textContent = reducciones;
        }

        // ===========================
        // FILTRADO
        // ===========================
        function initYearFilter() {
            const years = new Set();
            const cards = document.querySelectorAll('.comparison-card');
            cards.forEach(card => {
                const dates = card.querySelectorAll('.month-date');
                dates.forEach(d => {
                    const m = d.textContent.match(/\d{4}/);
                    if (m) years.add(m[0]);
                });
            });
            const yearFilter = document.getElementById('yearFilter');
            Array.from(years).sort((a,b) => b - a).forEach(y => {
                const opt = document.createElement('option'); 
                opt.value = y; 
                opt.textContent = y; 
                yearFilter.appendChild(opt);
            });
        }

        function filterCards() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedStatus = document.getElementById('statusFilter').value;

            const cards = document.querySelectorAll('.comparison-card');
            let visible = 0;
            cards.forEach(card => {
                let show = true;

                if (searchTerm) {
                    const serviceName = card.querySelector('.service-name')?.textContent.toLowerCase() || '';
                    const invoiceNumbers = Array.from(card.querySelectorAll('.invoice-number')).map(el => el.textContent.toLowerCase()).join(' ');
                    show = serviceName.includes(searchTerm) || invoiceNumbers.includes(searchTerm);
                }

                if (show && selectedYear) {
                    const dates = card.querySelectorAll('.month-date');
                    const hasYear = Array.from(dates).some(d => d.textContent.includes(selectedYear));
                    show = hasYear;
                }

                if (show && selectedStatus) {
                    const statusBadge = card.querySelector('.status-badge');
                    if (statusBadge) show = statusBadge.classList.contains(`status-${selectedStatus}`);
                }

                if (show) { 
                    card.classList.remove('hidden'); 
                    visible++; 
                } else { 
                    card.classList.add('hidden'); 
                }
            });

            document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.querySelectorAll('.comparison-card').forEach(c => c.classList.remove('hidden'));
            document.getElementById('noResults').style.display = 'none';
        }

        // ===========================
        // MODAL
        // ===========================
        function openModal(factura) {
            const modal = document.getElementById('serviceModal');

            const numero = factura.numero || factura.NumeroFactura || 'No disponible';
            const fecha = factura.fecha || factura.FechaEmision || null;
            const montoRaw = (typeof factura.monto !== 'undefined') ? factura.monto : (factura.MontoTotal || 0);
            const monto = Number(montoRaw) || 0;
            const desc = factura.descripcion || factura.Descripcion || factura.Cliente || '';

            // TITULO
            document.getElementById('modalTitle').textContent = `Factura #${numero}`;

            // INFORMACI√ìN
            document.getElementById('modalInvoiceInfo').innerHTML = `
                <div class="modal-info-row">
                    <div class="modal-info-label">N√∫mero:</div>
                    <div class="modal-info-value">${numero}</div>
                </div>
                <div class="modal-info-row">
                    <div class="modal-info-label">Fecha:</div>
                    <div class="modal-info-value">${formatDate(fecha)}</div>
                </div>
                <div class="modal-info-row">
                    <div class="modal-info-label">Monto:</div>
                    <div class="modal-info-value">${formatCurrencyCO(monto)}</div>
                </div>
            `;

            // MOSTRAR DETALLE DE LA FACTURA
            const servicesContainer = document.getElementById('modalServicesContainer');
            
            if (desc && desc.trim() !== '') {
                servicesContainer.innerHTML = `
                    <div style="background: #f8f9fa; 
                                padding: 20px; 
                                border-radius: 10px; 
                                border: 1px solid #dee2e6;
                                max-height: 400px;
                                overflow-y: auto;">
                        <pre style="white-space: pre-wrap; 
                                    font-family: 'Inter', Arial, sans-serif; 
                                    font-size: 0.9em; 
                                    line-height: 1.6;
                                    color: #333;
                                    margin: 0;
                                    background: transparent;
                                    border: none;
                                    padding: 0;">${escapeHtml(desc)}</pre>
                    </div>
                `;
            } else {
                servicesContainer.innerHTML = `
                    <div style="padding:40px 20px; text-align:center; background:#f8f9fa; border-radius:10px; border:2px dashed #ddd;">
                        <div style="font-size:3em; margin-bottom:10px;">üìã</div>
                        <div style="font-size:1.1em; color:#666; font-weight:500;">Sin detalle de factura</div>
                        <div style="font-size:0.9em; color:#999; margin-top:5px;">Esta factura no contiene informaci√≥n detallada</div>
                    </div>
                `;
            }

            // TOTAL
            document.getElementById('modalTotalAmount').textContent = formatCurrencyCO(monto);

            // Mostrar modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('serviceModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // ===========================
        // Eventos y arranque
        // ===========================
        document.addEventListener('DOMContentLoaded', function() {
            renderComparaciones(comparacionesData);
            setTimeout(initYearFilter, 50);

            // Filtros
            document.getElementById('searchInput').addEventListener('input', filterCards);
            document.getElementById('yearFilter').addEventListener('change', filterCards);
            document.getElementById('statusFilter').addEventListener('change', filterCards);
            document.getElementById('clearFilters').addEventListener('click', clearAllFilters);

            // Delegaci√≥n: click en invoice-item abre modal
            document.addEventListener('click', function(e) {
                const invoiceItem = e.target.closest('.invoice-item');
                if (invoiceItem) {
                    try {
                        const raw = invoiceItem.getAttribute('data-factura');
                        const facturaData = JSON.parse(decodeURIComponent(raw));
                        openModal(facturaData);
                    } catch (err) {
                        console.error('Error al abrir modal:', err);
                    }
                }
            });

            // Cerrar modal
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('serviceModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });

            // Efecto scroll header
            window.addEventListener('scroll', function() {
                const header = document.querySelector('.header');
                const searchContainer = document.getElementById('searchContainer');
                if (window.scrollY > 50) {
                    header.classList.add('scrolled');
                    searchContainer.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                    searchContainer.classList.remove('scrolled');
                }
            });

            console.log('Dashboard inicializado. Comparaciones:', (comparacionesData || []).length);
        });
    </script>
</body>
</html>