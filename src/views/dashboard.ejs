<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard de Facturas</title>
    <!-- Bootstrap (solo para estilos b√°sicos) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
 <style>
    /* ============================
       ESTILO BASE CORPORATIVO
       ============================ */
    :root {
        --sec-red: #e30613;
        --sec-dark: #1a1a1a;
        --sec-gray: #0b4f64;
        --sec-blue: #004b8d;
        --sec-light-blue: #1d7cd3;
        --sec-gradient: linear-gradient(135deg, #1d7cd3, #004b8d);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--sec-gray);
        padding: 20px;
    }

    /* ============================
       ENCABEZADO
       ============================ */
    .sticky-wrapper {
        position: sticky;
        top: 0;
        z-index: 1002;
        background: var(--sec-gray);
        padding-bottom: 10px;
    }

    .header {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        margin-bottom: 20px;
        border-left: 6px solid var(--sec-red);
    }

    .header.scrolled {
        box-shadow: 0 10px 22px rgba(0,0,0,0.25);
        transform: translateY(-2px);
    }

    .header h1 {
        font-size: 1.6rem;
        color: var(--sec-blue);
        font-weight: 700;
    }

    /* ============================
       BUSCADOR Y FILTROS
       ============================ */
    .search-container {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border-left: 5px solid var(--sec-light-blue);
    }

    #searchInput {
        padding: 14px 20px;
        border-radius: 10px;
        border: 2px solid #ddd;
        font-size: 1.1rem;
        transition: 0.2s;
        width: 100%;
    }

    #searchInput:focus {
        border-color: var(--sec-light-blue);
        box-shadow: 0 0 4px rgba(0,0,0,0.1);
    }

    .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filter-buttons select,
    .clear-btn {
        padding: 12px;
        border-radius: 8px;
        border: 2px solid #ddd;
        background: #fff;
        font-size: 1rem;
        transition: 0.2s;
    }

    .clear-btn:hover {
        background: var(--sec-light-blue);
        color: white;
        border-color: var(--sec-light-blue);
    }

    /* ============================
       TARJETAS DE ESTAD√çSTICAS
       ============================ */
    .stat-card {
        text-align:center;
        padding: 25px;
        background:rgb(17, 11, 49);
        border-radius:12px;
        border-top:5px solid var(--sec-blue);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }

    .stat-card h3 {
        color: var(--sec-dark);
        font-size: 0.95rem;
        text-transform: uppercase;
        opacity: 0.7;
    }

    .stat-card .number {
        font-size: 2.4rem;
        font-weight: bold;
        color: var(--sec-blue);
    }

    /* ============================
       TARJETA DE COMPARACI√ìN
       ============================ */
    .comparison-card {
        background: #f9fbfd; /* Azul suave */
        padding: 25px;
        border-radius: 12px;
        border-left: 6px solid var(--sec-light-blue);
        box-shadow: 0 4px 14px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        transition: 0.25s ease;
    }

    .comparison-card:hover {
        background: #f4f2fb;
        transform: translateX(4px);
        box-shadow: 0 8px 18px rgba(0,0,0,0.18);
    }

    .service-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding-bottom:15px;
        margin-bottom:20px;
        border-bottom:2px solid #eee;
    }

    .service-name {
        font-size:1.4rem;
        font-weight:600;
        color:var(--sec-dark);
    }

    /* ============================
       ESTADOS
       ============================ */
    .status-badge {
        padding:10px 22px;
        border-radius:20px;
        font-weight:bold;
        font-size:0.85rem;
        letter-spacing:0.5px;
        text-transform:uppercase;
    }

    .status-subio {
        background:#ffe3e3;
        color:#d40000;
        border:2px solid #d40000;
    }

    .status-bajo {
        background:#e5ffe8;
        color:#0c8e2a;
        border:2px solid #0c8e2a;
    }

    .status-estable {
        background:#fff3cd;
        color:#a88700;
        border:2px solid #a88700;
    }

    /* ============================
       CONTENIDO DE MESES
       ============================ */
    .month-box {
        background: #eef3f8;
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #d6dee8;
        transition: 0.2s ease;
    }

    .month-box:hover {
        background: #e3eaf2;
        border-color: #c2cedc;
    }

    /* ============================
       FACTURAS EN LISTA
       ============================ */
    .invoice-item {
        background: #ffffff;
        border-radius: 8px;
        border-left: 5px solid var(--sec-blue);
        padding: 12px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    }

    .invoice-item:hover {
        background: #f4f7fa;
        transform: translateX(6px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        border-left-color: var(--sec-red);
    }

    /* ============================
       MODAL
       ============================ */
    .modal-content {
        background: #f9fbfd;
        border-left: 8px solid var(--sec-blue);
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    }

    .modal-title {
        font-size:1.6rem;
        font-weight:700;
        color:var(--sec-blue);
    }

    .modal-services-title {
        font-weight:600;
        font-size:1.2rem;
        color: var(--sec-dark);
    }

    .table thead {
        background: var(--sec-blue);
        color:white;
    }
</style>


    <!-- MODAL -->
    <div class="service-modal" id="serviceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000;">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="background:white; border-radius:8px; padding:20px; max-width:900px; width:95%; max-height:85vh; margin:40px auto; overflow:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div id="modalTitle" style="font-weight:700; color:#333;">Detalle de Factura</div>
                <button id="modalClose" aria-label="Cerrar modal" style="background:#eee; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">√ó</button>
            </div>

            <div class="modal-invoice-info" id="modalInvoiceInfo" style="margin-bottom:12px;"></div>

            <div style="font-weight:700; margin-bottom:8px;">Servicios Incluidos</div>
            <div id="modalServicesContainer" style="margin-bottom:12px;"></div>

            <div style="background:#f0f0f0; padding:10px; border-radius:6px; text-align:center;">
                <div style="font-size:0.9rem; color:#555;">Total de la Factura</div>
                <div id="modalTotalAmount" style="font-weight:700; font-size:1.4rem; color:#111;">0</div>
            </div>
        </div>
    </div>

    <div class="container my-3">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <img src="/img/Securitas-logo-light.jpeg" alt="Logo" style="height:48px; margin-right:10px;">
                    <h2 class="m-0">Securitas Colombia - Dashboard de Facturas</h2>
                </div>
                <div class="mb-3">
                    <input id="searchInput" class="form-control" placeholder="üîç Buscar por servicio o n√∫mero de factura...">
                </div>
                <div class="d-flex gap-2 mb-3">
                    <select id="yearFilter" class="form-select">
                        <option value="">Todos los a√±os</option>
                    </select>
                    <select id="statusFilter" class="form-select">
                        <option value="">Todos los estados</option>
                        <option value="subio">‚Üó Aument√≥</option>
                        <option value="bajo">‚Üò Disminuy√≥</option>
                        <option value="estable">‚Üí Estable</option>
                    </select>
                    <button id="clearFilters" class="btn btn-outline-secondary">Limpiar</button>
                </div>
            </div>
        </div>

        <div id="comparacionesContainer"></div>

        <div id="noResults" style="display:none; text-align:center; padding:20px; margin-top:20px; border-radius:6px;">
            <h4>üîç No se encontraron resultados</h4>
            <p>Intenta ajustar los filtros o realiza una b√∫squeda diferente.</p>
        </div>
    </div>

    <!-- Script: EJS data injection -->
    <script>
        // EJS: comparaciones array injected from server
        const comparacionesData = <%- JSON.stringify(comparaciones || []) %>;
    </script>

    <script>
        // ---------- Helpers ----------
        function parseNumberFromString(input) {
            if (input == null) return 0;
            if (typeof input === 'number') return input;
            let s = String(input).trim();
            s = s.replace(/\s+/g, '');
            s = s.replace(/,/g, '.');
            s = s.replace(/[^0-9.]/g, '');
            if (s === '') return 0;
            const n = Number(s);
            return isNaN(n) ? 0 : n;
        }

        function formatCurrency(value) {
            const n = Number(value) || 0;
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 4
            }).format(n);
        }

        function formatCurrencyCO(valor) {
            const n = parseNumberFromString(valor);
            const partes = n.toFixed(2).split('.');
            let entero = partes[0];
            const decimales = partes[1];
            entero = entero.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            return `${entero},${decimales}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Fecha inv√°lida';
            return date.toLocaleDateString('es-CO', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        function encodeFactura(f) {
            return encodeURIComponent(JSON.stringify(f));
        }

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ---------- Parser (seguro, NO borra datos) ----------
        function parseServicios(desc) {
    if (!desc) return [];

    let text = String(desc);

    // ---------------------------------------------------------
    // 1) NORMALIZAR N√öMEROS ROTOS
    // Une n√∫meros separados por espacios que vienen del PDF:
    // Ej: "7 942 60 8,00" -> "7942608,00"
    // ---------------------------------------------------------
    text = text.replace(/(\d)\s+(?=\d)/g, '$1'); 

    // Une miles con decimales separados por puntos o espacios
    text = text.replace(/(\d)\.(?=\d{3}\b)/g, '$1');
    text = text.replace(/(\d)\s(?=\d{3}\b)/g, '$1');

    // ---------------------------------------------------------
    // 2) Separadores inteligentes para intentar formar filas
    // ---------------------------------------------------------
    text = text.replace(/([A-Za-z\)\%])(\d)/g, '$1\n$2');
    text = text.replace(/(\d)([A-Za-z])/g, '$1\n$2');

    // Saltos alrededor de montos muy grandes
    text = text.replace(/(\d{1,9},\d{2})/g, '\n$1\n');

    // ---------------------------------------------------------
    // 3) L√≠neas limpias
    // ---------------------------------------------------------
    const rawLines = text
        .split(/\n+/)
        .map(l => l.trim())
        .filter(l => l.length > 0);

    const servicios = [];

    // ---------------------------------------------------------
    // 4) REGEX NUEVO ‚Äî ACEPTA N√öMEROS GRANDES Y BIEN UNIDOS
    // ---------------------------------------------------------
    const filaRegex =
        /^(.+?)\s+(\d[\d\.,]*)\s+(\d[\d\.,]*)\s+(\d[\d\.,]*)$/;

    function normalizeNumber(v) {
        if (!v) return 0;

        // eliminar espacios
        v = v.replace(/\s+/g, '');

        // miles a puntos
        v = v.replace(/\.(?=\d{3}\b)/g, '');

        // convertir coma decimal a punto
        v = v.replace(/,/g, '.');

        return parseFloat(v) || 0;
    }

    // ---------------------------------------------------------
    // 5) INTELIGENCIA PARA UNIR L√çNEAS 
    // (hasta 4 l√≠neas si el PDF vino muy roto)
    // ---------------------------------------------------------
    for (let i = 0; i < rawLines.length; i++) {
        let line = rawLines[i];

        let matches = null;
        matches = line.match(filaRegex);

        if (matches) {
            servicios.push({
                nombre: matches[1].trim(),
                cantidad: normalizeNumber(matches[2]),
                unitario: normalizeNumber(matches[3]),
                total: normalizeNumber(matches[4])
            });
            continue;
        }

        // Unir +1
        if (i + 1 < rawLines.length) {
            let merged = line + " " + rawLines[i + 1];
            matches = merged.match(filaRegex);
            if (matches) {
                servicios.push({
                    nombre: matches[1].trim(),
                    cantidad: normalizeNumber(matches[2]),
                    unitario: normalizeNumber(matches[3]),
                    total: normalizeNumber(matches[4])
                });
                i++;
                continue;
            }
        }

        // Unir +2
        if (i + 2 < rawLines.length) {
            let merged = line + " " + rawLines[i + 1] + " " + rawLines[i + 2];
            matches = merged.match(filaRegex);
            if (matches) {
                servicios.push({
                    nombre: matches[1].trim(),
                    cantidad: normalizeNumber(matches[2]),
                    unitario: normalizeNumber(matches[3]),
                    total: normalizeNumber(matches[4])
                });
                i += 2;
                continue;
            }
        }

        // Unir +3 l√≠neas (caso extremo PDF)
        if (i + 3 < rawLines.length) {
            let merged =
                line + " " + rawLines[i + 1] + " " + rawLines[i + 2] + " " + rawLines[i + 3];

            matches = merged.match(filaRegex);
            if (matches) {
                servicios.push({
                    nombre: matches[1].trim(),
                    cantidad: normalizeNumber(matches[2]),
                    unitario: normalizeNumber(matches[3]),
                    total: normalizeNumber(matches[4])
                });
                i += 3;
                continue;
            }
        }
    }

    return servicios;
}


        // ---------- Renderizado ----------
        function renderComparaciones(datos) {
            const container = document.getElementById('comparacionesContainer');

            if (!datos || datos.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-light">No hay datos para mostrar. Sube facturas PDF para ver las comparaciones mes a mes.</div>
                `;
                return;
            }

            const html = datos.map(comp => {
                // Mes anterior
                const facturasAnterior = (comp.facturasAnterior || []).map(f => {
                    return `
                        <div class="invoice-item" data-factura='${encodeFactura({
                            numero: f.numero,
                            fecha: f.fecha,
                            monto: f.monto,
                            descripcion: f.descripcion || null,
                            Cliente: f.Cliente || null
                        })}' style="border:1px solid #e9ecef; padding:8px; border-radius:6px; margin-bottom:6px; cursor:pointer;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600;">#${escapeHtml(f.numero)}</div>
                                <div style="font-weight:700;">$${formatCurrency(f.monto)}</div>
                            </div>
                            <div style="color:#6c757d; font-size:0.9rem;">${formatDate(f.fecha)}</div>
                        </div>
                    `;
                }).join('');

                // Mes actual
                const facturasActual = (comp.facturasActual || []).map(f => {
                    return `
                        <div class="invoice-item" data-factura='${encodeFactura({
                            numero: f.numero,
                            fecha: f.fecha,
                            monto: f.monto,
                            descripcion: f.descripcion || null,
                            Cliente: f.Cliente || null
                        })}' style="border:1px solid #e9ecef; padding:8px; border-radius:6px; margin-bottom:6px; cursor:pointer;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600;">#${escapeHtml(f.numero)}</div>
                                <div style="font-weight:700;">$${formatCurrency(f.monto)}</div>
                            </div>
                            <div style="color:#6c757d; font-size:0.9rem;">${formatDate(f.fecha)}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div style="font-weight:700; font-size:1.05rem;">${escapeHtml(comp.servicio)}</div>
                                <div style="font-weight:700; padding:6px 10px; border-radius:12px; background:#f1f3f5;">${comp.estado === 'subio' ? '‚Üó Aument√≥' : comp.estado === 'bajo' ? '‚Üò Disminuy√≥' : '‚Üí Estable'}</div>
                            </div>

                            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                                <div style="flex:1; min-width:260px; background:#f8f9fa; padding:10px; border-radius:6px;">
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">Mes Anterior</div>
                                    <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(comp.mesAnterior || '')}</div>
                                    <div style="font-weight:700; color:#333; margin-bottom:6px;">$${formatCurrency(comp.montoAnterior)}</div>
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">${comp.cantidadAnterior || 0} factura(s)</div>
                                    <div>${facturasAnterior || ''}</div>
                                </div>

                                <div style="min-width:120px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                    <div style="font-size:2rem;">${comp.estado === 'subio' ? '‚Üó' : comp.estado === 'bajo' ? '‚Üò' : '‚Üí'}</div>
                                    <div style="font-weight:700; margin-top:6px;">${comp.diferencia >= 0 ? '+' : ''}$${formatCurrency(Math.abs(comp.diferencia || 0))}</div>
                                    <div style="color:#6c757d; font-size:0.85rem;">(${comp.porcentaje >= 0 ? '+' : ''}${(comp.porcentaje || 0).toFixed(2)}%)</div>
                                </div>

                                <div style="flex:1; min-width:260px; background:#f8f9fa; padding:10px; border-radius:6px;">
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">Mes Actual</div>
                                    <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(comp.mesActual || '')}</div>
                                    <div style="font-weight:700; color:#333; margin-bottom:6px;">$${formatCurrency(comp.montoActual)}</div>
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">${comp.cantidadActual || 0} factura(s)</div>
                                    <div>${facturasActual || ''}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ---------- Modal logic ----------
        function openModal(factura) {
            const modal = document.getElementById('serviceModal');

            const numero = factura.numero || factura.NumeroFactura || 'No disponible';
            const fecha = factura.fecha || factura.FechaEmision || null;
            const montoRaw = (typeof factura.monto !== 'undefined') ? factura.monto : (factura.MontoTotal || 0);
            const monto = parseNumberFromString(montoRaw) || 0;
            const desc = factura.descripcion || factura.Descripcion || factura.Cliente || '';

            document.getElementById('modalTitle').textContent = `Factura #${numero}`;

            document.getElementById('modalInvoiceInfo').innerHTML = `
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <div style="min-width:140px;"><strong>N√∫mero:</strong><div>${escapeHtml(numero)}</div></div>
                    <div style="min-width:180px;"><strong>Fecha:</strong><div>${formatDate(fecha)}</div></div>
                    <div style="min-width:140px;"><strong>Monto:</strong><div>${formatCurrencyCO(monto)}</div></div>
                </div>
            `;

            const servicesContainer = document.getElementById('modalServicesContainer');

            // Parse services safely (no deletion)
            const servicios = parseServicios(desc);

            if (servicios.length > 0) {
                // Render table
                let rows = servicios.map(s => {
                    return `<tr>
                        <td>${escapeHtml(String(s.nombre || ''))}</td>
                        <td style="text-align:center;">${escapeHtml(String(s.cantidad || ''))}</td>
                        <td style="text-align:right;">${formatCurrencyCO(s.unitario)}</td>
                        <td style="text-align:right;">${formatCurrencyCO(s.total)}</td>
                    </tr>`;
                }).join('');

                servicesContainer.innerHTML = `
                    <div style="overflow:auto;">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Servicio</th>
                                    <th style="width:80px; text-align:center;">Cant.</th>
                                    <th style="width:140px; text-align:right;">Precio Unit.</th>
                                    <th style="width:140px; text-align:right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                // No services detected: show formatted raw text but intact
                const clean = String(desc)
                    .replace(/([A-Za-z\)])(\d)/g, "$1 $2")
                    .replace(/(\d)([A-Za-z])/g, "$1 $2")
                    .replace(/(\d{1,3}[\s\.,]\d{3}[\s\.,]\d{2})/g, "\n$1\n");

                servicesContainer.innerHTML = `
                    <div style="background:#f8f9fa; padding:12px; border-radius:6px; border:1px solid #e9ecef; max-height:420px; overflow:auto;">
                        <pre style="white-space:pre-wrap; margin:0; font-family:monospace; font-size:0.9rem; color:#333;">${escapeHtml(clean)}</pre>
                    </div>
                `;
            }

            document.getElementById('modalTotalAmount').textContent = formatCurrencyCO(monto);

            // show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('serviceModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        // ---------- Events & init ----------
        document.addEventListener('DOMContentLoaded', function() {
            renderComparaciones(comparacionesData);
            setTimeout(initYearFilter, 50);

            document.getElementById('searchInput').addEventListener('input', filterCards);
            document.getElementById('yearFilter').addEventListener('change', filterCards);
            document.getElementById('statusFilter').addEventListener('change', filterCards);
            document.getElementById('clearFilters').addEventListener('click', clearAllFilters);

            // Delegated click to open modal
            document.addEventListener('click', function(e) {
                const invoiceItem = e.target.closest('.invoice-item');
                if (invoiceItem) {
                    try {
                        const raw = invoiceItem.getAttribute('data-factura');
                        const facturaData = JSON.parse(decodeURIComponent(raw));
                        openModal(facturaData);
                    } catch (err) {
                        console.error('Error al abrir modal:', err);
                    }
                }
            });

            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('serviceModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
        });

        // ---------- Filtering helpers ----------
        function initYearFilter() {
            const years = new Set();
            const cards = document.querySelectorAll('#comparacionesContainer .card');
            cards.forEach(card => {
                const text = card.textContent;
                const m = text.match(/\b(20\d{2})\b/);
                if (m) years.add(m[1]);
            });
            const yearFilter = document.getElementById('yearFilter');
            Array.from(years).sort((a,b) => b - a).forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearFilter.appendChild(opt);
            });
        }

        function filterCards() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedStatus = document.getElementById('statusFilter').value;

            const cards = document.querySelectorAll('#comparacionesContainer .card');
            let visible = 0;
            cards.forEach(card => {
                let show = true;

                if (searchTerm) {
                    const serviceName = (card.querySelector('div[style*="font-weight:700"]')?.textContent || '').toLowerCase();
                    const invoiceNumbers = Array.from(card.querySelectorAll('.invoice-item .invoice-header .invoice-number') || []).map(el => el.textContent.toLowerCase()).join(' ');
                    show = serviceName.includes(searchTerm) || invoiceNumbers.includes(searchTerm);
                }

                if (show && selectedYear) {
                    show = card.textContent.includes(selectedYear);
                }

                if (show && selectedStatus) {
                    const badgeText = (card.querySelector('div[style*="padding:6px 10px"]')?.textContent || '').toLowerCase();
                    if (selectedStatus === 'subio') show = badgeText.includes('‚Üó');
                    if (selectedStatus === 'bajo') show = badgeText.includes('‚Üò');
                    if (selectedStatus === 'estable') show = badgeText.includes('‚Üí');
                }

                if (show) {
                    card.style.display = '';
                    visible++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.querySelectorAll('#comparacionesContainer .card').forEach(c => c.style.display = '');
            document.getElementById('noResults').style.display = 'none';
        }
    </script>
</body>
</html>
