<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard de Facturas</title>
    <!-- Bootstrap (solo para estilos b√°sicos) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>


    <!-- MODAL -->
    <div class="service-modal" id="serviceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000;">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle" style="background:white; border-radius:8px; padding:20px; max-width:900px; width:95%; max-height:85vh; margin:40px auto; overflow:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div id="modalTitle" style="font-weight:700; color:#333;">Detalle de Factura</div>
                <button id="modalClose" aria-label="Cerrar modal" style="background:#eee; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;">√ó</button>
            </div>

            <div class="modal-invoice-info" id="modalInvoiceInfo" style="margin-bottom:12px;"></div>

            <div style="font-weight:700; margin-bottom:8px;">Servicios Incluidos</div>
            <div id="modalServicesContainer" style="margin-bottom:12px;"></div>

            <div style="background:#f0f0f0; padding:10px; border-radius:6px; text-align:center;">
                <div style="font-size:0.9rem; color:#555;">Total de la Factura</div>
                <div id="modalTotalAmount" style="font-weight:700; font-size:1.4rem; color:#111;">$0</div>
            </div>
        </div>
    </div>

    <div class="container my-3">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <img src="/img/Securitas-logo-light.jpeg" alt="Logo" style="height:48px; margin-right:10px;">
                    <h2 class="m-0">Securitas Colombia - Dashboard de Facturas</h2>
                </div>
                <div class="mb-3">
                    <input id="searchInput" class="form-control"
                        placeholder="üîç Buscar por servicio o n√∫mero de factura...">
                </div>
                <div class="d-flex gap-2 mb-3">
                    <select id="yearFilter" class="form-select">
                        <option value="">Todos los a√±os</option>
                    </select>
                    <select id="statusFilter" class="form-select">
                        <option value="">Todos los estados</option>
                        <option value="subio">‚Üó Aument√≥</option>
                        <option value="bajo">‚Üò Disminuy√≥</option>
                        <option value="estable">‚Üí Estable</option>
                    </select>
                    <button id="clearFilters" class="btn btn-outline-secondary">Limpiar</button>
                </div>
            </div>
        </div>

        <div id="comparacionesContainer"></div>

        <div id="noResults" style="display:none; text-align:center; padding:20px; margin-top:20px; border-radius:6px;">
            <h4>üîç No se encontraron resultados</h4>
            <p>Intenta ajustar los filtros o realiza una b√∫squeda diferente.</p>
        </div>
    </div>

    <!-- Script: EJS data injection -->
    <script>
        // EJS: comparaciones array injected from server
        const comparacionesData = <%- JSON.stringify(comparaciones || []) %>;
    </script>

    <script>
        // ---------- Helpers ----------
        function parseNumberFromString(input) {
            if (input == null) return 0;
            if (typeof input === 'number') return input;
            
            let s = String(input).trim();
            
            // Remover espacios en blanco
            s = s.replace(/\s+/g, '');
            
            // Remover s√≠mbolos de moneda
            s = s.replace(/[$]/g, '');
            
            // Contar puntos y comas
            const puntos = (s.match(/\./g) || []).length;
            const comas = (s.match(/,/g) || []).length;
            
            // Si tiene m√∫ltiples puntos, son separadores de miles (formato: 1.234.567)
            if (puntos > 1) {
                s = s.replace(/\./g, ''); // Eliminar separadores de miles
                s = s.replace(/,/g, '.'); // Convertir coma decimal a punto
            }
            // Si tiene m√∫ltiples comas, son separadores de miles (formato: 1,234,567.00)
            else if (comas > 1) {
                s = s.replace(/,/g, ''); // Eliminar separadores de miles
                // El punto ya es decimal
            }
            // Si tiene punto Y coma
            else if (puntos === 1 && comas === 1) {
                const posPunto = s.indexOf('.');
                const posComa = s.indexOf(',');
                
                // Si el punto viene antes que la coma: 1.234,56 (formato europeo)
                if (posPunto < posComa) {
                    s = s.replace(/\./g, ''); // Eliminar separador de miles
                    s = s.replace(/,/g, '.'); // Convertir coma decimal a punto
                }
                // Si la coma viene antes que el punto: 1,234.56 (formato americano)
                else {
                    s = s.replace(/,/g, ''); // Eliminar separador de miles
                    // El punto ya es decimal
                }
            }
            // Si solo tiene UN punto
            else if (puntos === 1 && comas === 0) {
                const partes = s.split('.');
                const parteDecimal = partes[1] || '';
                
                // Si hay exactamente 3 d√≠gitos despu√©s del punto, puede ser miles o decimal
                if (parteDecimal.length === 3) {
                    // Verificar si termina en "00" o ".00" que indicar√≠a formato americano
                    // Ejemplo: 36.165 sin decimales = 36,165 (treinta y seis mil)
                    // Si el n√∫mero completo es peque√±o (< 1000), probablemente es decimal
                    const numeroCompleto = parseFloat(s);
                    if (numeroCompleto < 1000 && partes[0].length <= 2) {
                        // Es decimal: 36.165
                        s = s; // Mantener como est√°
                    } else {
                        // Es separador de miles: 36.165 = 36165
                        s = s.replace(/\./g, '');
                    }
                }
                // Si hay 2 o menos d√≠gitos despu√©s del punto, es decimal
                else if (parteDecimal.length <= 2) {
                    s = s; // Mantener el punto como decimal
                }
                // Si hay m√°s de 3 d√≠gitos, es separador de miles
                else {
                    s = s.replace(/\./g, '');
                }
            }
            // Si solo tiene UNA coma
            else if (comas === 1 && puntos === 0) {
                const partes = s.split(',');
                const parteDecimal = partes[1] || '';
                
                // Si hay exactamente 3 d√≠gitos despu√©s de la coma, puede ser miles
                if (parteDecimal.length === 3) {
                    // Verificar contexto similar al punto
                    const numeroCompleto = parseFloat(s.replace(',', '.'));
                    if (numeroCompleto < 1000 && partes[0].length <= 2) {
                        // Es decimal
                        s = s.replace(/,/g, '.');
                    } else {
                        // Es separador de miles
                        s = s.replace(/,/g, '');
                    }
                }
                // Si hay 2 o menos d√≠gitos, es decimal
                else if (parteDecimal.length <= 2) {
                    s = s.replace(/,/g, '.'); // Convertir coma decimal a punto
                }
                // Si hay m√°s de 3 d√≠gitos, es separador de miles
                else {
                    s = s.replace(/,/g, '');
                }
            }
            
            // Limpiar cualquier caracter no num√©rico excepto punto decimal
            s = s.replace(/[^0-9.]/g, '');
            
            if (s === '') return 0;
            const n = Number(s);
            return isNaN(n) ? 0 : n;
        }

        function formatCurrency(value) {
            const n = Number(value) || 0;
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 4
            }).format(n);
        }

       function formatCurrencyCO(valor) {
    // Si el valor ya es un n√∫mero, usarlo directamente
    let n;
    if (typeof valor === 'number') {
        n = valor;
    } else {
        n = parseNumberFromString(valor);
    }
    
    // Verificar si tiene decimales significativos
    const hasDecimals = (n % 1) !== 0;
    
    const partes = hasDecimals ? n.toFixed(2).split('.') : Math.round(n).toString().split('.');
    let entero = partes[0];
    const decimales = partes[1];
    
    // Separador de miles con punto
    entero = entero.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    // Solo mostrar decimales si existen y son significativos
    if (hasDecimals && decimales && decimales !== '00') {
        return `${entero},${decimales}`;
    }
    
    return entero;
}

        function formatDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Fecha inv√°lida';
            return date.toLocaleDateString('es-CO', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
        }

        function encodeFactura(f) {
            return encodeURIComponent(JSON.stringify(f));
        }

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ---------- Parser (seguro, NO borra datos) ----------
        function parseServicios(desc) {
    if (!desc) return [];

    let text = String(desc);
    console.log('Parser - Texto original:', text.substring(0, 300));

    // ---------------------------------------------------------
    // ESTRATEGIA NUEVA: Buscar patrones espec√≠ficos
    // ---------------------------------------------------------
    
    const servicios = [];
    
    // Patr√≥n 0: Detectar formato simple "LatAm GDC" o facturas de Securitas US
    // Formato: "DESCRIPTION\nLatAm GDC CC20415 May costs\nUSD\n36,165.00\nBeatriz..."
    const latamMatch = text.match(/LatAm\s+GDC\s+[^\n]+/i);
    if (latamMatch) {
        const servicioNombre = latamMatch[0].trim();
        
        // Buscar el monto que viene despu√©s (formato: "36,165.00" o "36.165,00")
        const afterLatam = text.substring(latamMatch.index + latamMatch[0].length);
        const montoMatch = afterLatam.match(/USD\s*([\d,\.]+)/i);
        
        let monto = 0;
        if (montoMatch) {
            // Puede venir como "36,165.00" (formato US) o "36.165,00" (formato EU)
            const montoStr = montoMatch[1];
            // Detectar formato: si tiene coma antes del punto, es formato US
            if (montoStr.includes(',') && montoStr.includes('.')) {
                const posComma = montoStr.indexOf(',');
                const posDot = montoStr.indexOf('.');
                if (posComma < posDot) {
                    // Formato US: 36,165.00
                    monto = parseFloat(montoStr.replace(/,/g, ''));
                } else {
                    // Formato EU: 36.165,00
                    monto = parseFloat(montoStr.replace(/\./g, '').replace(',', '.'));
                }
            } else if (montoStr.includes(',')) {
                // Solo coma: formato EU decimal
                monto = parseFloat(montoStr.replace(/\./g, '').replace(',', '.'));
            } else if (montoStr.includes('.')) {
                // Solo punto: podr√≠a ser miles o decimal
                const partes = montoStr.split('.');
                if (partes[1] && partes[1].length === 2) {
                    // Es decimal: 36.16
                    monto = parseFloat(montoStr);
                } else if (partes[1] && partes[1].length === 3) {
                    // Es miles: 36.165
                    monto = parseFloat(montoStr.replace(/\./g, ''));
                } else {
                    monto = parseFloat(montoStr);
                }
            } else {
                monto = parseFloat(montoStr);
            }
        }
        
        console.log('Parser - LatAm GDC detectado:', { servicioNombre, monto });
        
        servicios.push({
            nombre: servicioNombre,
            cantidad: 1,
            unitario: monto,
            total: monto
        });
        
        return servicios; // Retornar inmediatamente para este tipo de factura
    }
    
    // Patr√≥n 1: Detectar "Global IT Services - Office 365" seguido de n√∫meros
    // El texto viene como: "Office 3651,0052 661 222,2252 661 222,22"
    const officeMatch = text.match(/Global IT Services\s*-\s*Office\s*365([^\n]*)/i);
    if (officeMatch) {
        // Extraer todo lo que sigue despu√©s de "Office 365"
        const afterOffice = officeMatch[1] + text.substring(officeMatch.index + officeMatch[0].length, officeMatch.index + officeMatch[0].length + 300);
        console.log('Parser - Despu√©s de Office 365:', afterOffice);
        
        // Patr√≥n espec√≠fico: "3651,0052 661 222,2252 661 222,22"
        // Significa: cantidad=1,00  precio=52.661.222,22  total=52.661.222,22
        // El "365" es parte del nombre, los n√∫meros reales empiezan despu√©s
        
        // Buscar: (cantidad con decimales)(monto grande con espacios)(monto grande con espacios)
        // Ejemplo: "1,00 52 661 222,22 52 661 222,22"
        const numMatch = afterOffice.match(/(\d),(\d{2})(\d+[\s\d]+,\d{2})(\d+[\s\d]+,\d{2})/);
        
        if (numMatch) {
            const cantidad = parseFloat(numMatch[1] + '.' + numMatch[2]) || 1;
            
            // Extraer precio unitario: "52 661 222,22"
            const unitarioStr = numMatch[3].trim();
            const unitario = parseFloat(unitarioStr.replace(/\s/g, '').replace(',', '.')) || 0;
            
            // Extraer total: "52 661 222,22"
            const totalStr = numMatch[4].trim();
            const total = parseFloat(totalStr.replace(/\s/g, '').replace(',', '.')) || 0;
            
            console.log('Parser - Office 365 extra√≠do:', { cantidad, unitario, total });
            
            servicios.push({
                nombre: 'Global IT Services - Office 365',
                cantidad: cantidad,
                unitario: unitario,
                total: total
            });
        }
    }
    
    // Patr√≥n 2: Detectar "Mark-up"
    const markupMatch = text.match(/Mark-up\s+For\s+actual\s+consumption[^0-9]*(\d),(\d{2})(\d+[\s\d]+,\d{2})(\d+[\s\d]+,\d{2})/i);
    if (markupMatch) {
        console.log('Parser - Mark-up match encontrado:', markupMatch);
        
        const cantidad = parseFloat(markupMatch[1] + '.' + markupMatch[2]) || 1;
        
        // Extraer precio unitario
        const unitarioStr = markupMatch[3].trim();
        const unitario = parseFloat(unitarioStr.replace(/\s/g, '').replace(',', '.')) || 0;
        
        // Extraer total
        const totalStr = markupMatch[4].trim();
        const total = parseFloat(totalStr.replace(/\s/g, '').replace(',', '.')) || 0;
        
        console.log('Parser - Mark-up extra√≠do:', { cantidad, unitario, total });
        
        servicios.push({
            nombre: 'Mark-up For actual consumption of licenses per month and price per license, see attached appendix',
            cantidad: cantidad,
            unitario: unitario,
            total: total
        });
    }
    
    console.log('Parser - Servicios detectados:', servicios);
    
    // Si no detect√≥ servicios con los patrones espec√≠ficos, intentar m√©todo original
    if (servicios.length > 0) {
        return servicios;
    }

    // ---------------------------------------------------------
    // M√âTODO ORIGINAL (fallback)
    // ---------------------------------------------------------
    
    // Normalizar texto
    text = text.replace(/Office\s*365(\d)/g, 'Office 365\n$1');
    text = text.replace(/(\d,\d{2})(\d{2,})/g, '$1\n$2');
    text = text.replace(/(\d{3}\s\d{3}\s\d{3},\d{2})(\d)/g, '$1\n$2');
    text = text.replace(/(\d{3}\s\d{3},\d{2})(\d)/g, '$1\n$2');
    text = text.replace(/(\d{3},\d{2})(\d{2,})/g, '$1\n$2');
    text = text.replace(/([A-Za-z\)])(\d{1,3}\s+\d{3})/g, '$1\n$2');
    text = text.replace(/(\d{3}\s\d{3}\s\d{3},\d{2})\s*(\d{1,2}\s)/g, '$1\n$2');

    const rawLines = text
        .split(/\n+/)
        .map(l => l.trim())
        .filter(l => l.length > 0);

    const filaRegex = /^(.+?)\s+([\d\s]+,\d{2})\s+([\d\s]+,\d{2})\s+([\d\s]+,\d{2})$/;

    function normalizeNumber(v) {
        if (!v) return 0;
        v = v.replace(/\s+/g, '');
        v = v.replace(/\.(?=\d{3}\b)/g, '');
        v = v.replace(/,/g, '.');
        return parseFloat(v) || 0;
    }

    for (let i = 0; i < rawLines.length; i++) {
        let line = rawLines[i];
        let matches = null;
        matches = line.match(filaRegex);

        if (matches) {
            servicios.push({
                nombre: matches[1].trim(),
                cantidad: normalizeNumber(matches[2]),
                unitario: normalizeNumber(matches[3]),
                total: normalizeNumber(matches[4])
            });
            continue;
        }

        // Intentar unir hasta 5 l√≠neas
        for (let j = 1; j <= 5 && i + j < rawLines.length; j++) {
            let merged = line;
            for (let k = 1; k <= j; k++) {
                merged += " " + rawLines[i + k];
            }
            matches = merged.match(filaRegex);
            if (matches) {
                servicios.push({
                    nombre: matches[1].trim(),
                    cantidad: normalizeNumber(matches[2]),
                    unitario: normalizeNumber(matches[3]),
                    total: normalizeNumber(matches[4])
                });
                i += j;
                break;
            }
        }
    }

    return servicios;
}


        // ---------- Renderizado ----------
        function renderComparaciones(datos) {
            const container = document.getElementById('comparacionesContainer');

            if (!datos || datos.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-light">No hay datos para mostrar. Sube facturas PDF para ver las comparaciones mes a mes.</div>
                `;
                return;
            }

            const html = datos.map(comp => {
                // Mes anterior
                const facturasAnterior = (comp.facturasAnterior || []).map(f => {
                    // Parsear el monto correctamente antes de codificarlo
                    let montoParsed;
                    if (typeof f.monto === 'string') {
                        montoParsed = parseNumberFromString(f.monto);
                    } else if (typeof f.monto === 'number') {
                        // Corregir n√∫meros mal parseados (36.165 ‚Üí 36165)
                        const strNum = f.monto.toString();
                        const partes = strNum.split('.');
                        if (partes.length === 2 && partes[1].length === 3 && f.monto < 1000) {
                            montoParsed = parseFloat(strNum.replace('.', ''));
                        } else {
                            montoParsed = f.monto;
                        }
                    } else {
                        montoParsed = 0;
                    }
                    
                    return `
                        <div class="invoice-item" data-factura='${encodeFactura({
                            numero: f.numero,
                            fecha: f.fecha,
                            monto: montoParsed,
                            descripcion: f.descripcion || null,
                            Cliente: f.Cliente || null
                        })}' style="border:1px solid #e9ecef; padding:8px; border-radius:6px; margin-bottom:6px; cursor:pointer;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600;">#${escapeHtml(f.numero)}</div>
                                <div style="font-weight:700;">${formatCurrency(montoParsed)}</div>
                            </div>
                            <div style="color:#6c757d; font-size:0.9rem;">${formatDate(f.fecha)}</div>
                        </div>
                    `;
                }).join('');

                // Mes actual
                const facturasActual = (comp.facturasActual || []).map(f => {
                    // Parsear el monto correctamente antes de codificarlo
                    let montoParsed;
                    if (typeof f.monto === 'string') {
                        montoParsed = parseNumberFromString(f.monto);
                    } else if (typeof f.monto === 'number') {
                        // Corregir n√∫meros mal parseados (36.165 ‚Üí 36165)
                        const strNum = f.monto.toString();
                        const partes = strNum.split('.');
                        if (partes.length === 2 && partes[1].length === 3 && f.monto < 1000) {
                            montoParsed = parseFloat(strNum.replace('.', ''));
                        } else {
                            montoParsed = f.monto;
                        }
                    } else {
                        montoParsed = 0;
                    }
                    
                    return `
                        <div class="invoice-item" data-factura='${encodeFactura({
                            numero: f.numero,
                            fecha: f.fecha,
                            monto: montoParsed,
                            descripcion: f.descripcion || null,
                            Cliente: f.Cliente || null
                        })}' style="border:1px solid #e9ecef; padding:8px; border-radius:6px; margin-bottom:6px; cursor:pointer;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600;">#${escapeHtml(f.numero)}</div>
                                <div style="font-weight:700;">${formatCurrency(montoParsed)}</div>
                            </div>
                            <div style="color:#6c757d; font-size:0.9rem;">${formatDate(f.fecha)}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div style="font-weight:700; font-size:1.05rem;">${escapeHtml(comp.servicio)}</div>
                                <div style="font-weight:700; padding:6px 10px; border-radius:12px; background:#f1f3f5;">${comp.estado === 'subio' ? '‚Üó Aument√≥' : comp.estado === 'bajo' ? '‚Üò Disminuy√≥' : '‚Üí Estable'}</div>
                            </div>

                            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                                <div style="flex:1; min-width:260px; background:#f8f9fa; padding:10px; border-radius:6px;">
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">Mes Anterior</div>
                                    <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(comp.mesAnterior || '')}</div>
                                    <div style="font-weight:700; color:#333; margin-bottom:6px;">$${formatCurrency(comp.montoAnterior)}</div>
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">${comp.cantidadAnterior || 0} factura(s)</div>
                                    <div>${facturasAnterior || ''}</div>
                                </div>

                                <div style="min-width:120px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                    <div style="font-size:2rem;">${comp.estado === 'subio' ? '‚Üó' : comp.estado === 'bajo' ? '‚Üò' : '‚Üí'}</div>
                                    <div style="font-weight:700; margin-top:6px;">${comp.diferencia >= 0 ? '+' : ''}$${formatCurrency(Math.abs(comp.diferencia || 0))}</div>
                                    <div style="color:#6c757d; font-size:0.85rem;">(${comp.porcentaje >= 0 ? '+' : ''}${(comp.porcentaje || 0).toFixed(2)}%)</div>
                                </div>

                                <div style="flex:1; min-width:260px; background:#f8f9fa; padding:10px; border-radius:6px;">
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">Mes Actual</div>
                                    <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(comp.mesActual || '')}</div>
                                    <div style="font-weight:700; color:#333; margin-bottom:6px;">$${formatCurrency(comp.montoActual)}</div>
                                    <div style="font-size:0.85rem; color:#6c757d; margin-bottom:6px;">${comp.cantidadActual || 0} factura(s)</div>
                                    <div>${facturasActual || ''}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ---------- Modal logic ----------
        function openModal(factura) {
            const modal = document.getElementById('serviceModal');

            const numero = factura.numero || factura.NumeroFactura || 'No disponible';
            const fecha = factura.fecha || factura.FechaEmision || null;
            const montoRaw = (typeof factura.monto !== 'undefined') ? factura.monto : (factura.MontoTotal || 0);
            
            // CR√çTICO: Siempre parsear el monto, incluso si ya es n√∫mero
            // Porque 36.165 como n√∫mero JS = 36 con decimales, cuando deber√≠a ser 36165
            let monto;
            if (typeof montoRaw === 'string') {
                monto = parseNumberFromString(montoRaw);
            } else if (typeof montoRaw === 'number') {
                // Si es un n√∫mero peque√±o con 3 decimales, probablemente fue mal parseado
                const strNum = montoRaw.toString();
                const partes = strNum.split('.');
                if (partes.length === 2 && partes[1].length === 3 && montoRaw < 1000) {
                    // Ejemplo: 36.165 ‚Üí convertir a 36165
                    monto = parseFloat(strNum.replace('.', ''));
                } else {
                    monto = montoRaw;
                }
            } else {
                monto = 0;
            }
            
            const desc = factura.descripcion || factura.Descripcion || factura.Cliente || '';
            
            console.log('Modal - Monto raw:', montoRaw, 'tipo:', typeof montoRaw, 'Monto final:', monto);
            console.log('Modal - Descripci√≥n recibida:', desc);
            console.log('Modal - Primeros 200 caracteres:', desc.substring(0, 200));

            document.getElementById('modalTitle').textContent = `Factura #${numero}`;

            document.getElementById('modalInvoiceInfo').innerHTML = `
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <div style="min-width:140px;"><strong>N√∫mero:</strong><div>${escapeHtml(numero)}</div></div>
                    <div style="min-width:180px;"><strong>Fecha:</strong><div>${formatDate(fecha)}</div></div>
                    <div style="min-width:140px;"><strong>Monto:</strong><div>$${formatCurrencyCO(monto)}</div></div>
                </div>
            `;

            const servicesContainer = document.getElementById('modalServicesContainer');

            // Parse services safely (no deletion)
            const servicios = parseServicios(desc);
            
            console.log('Modal - Servicios parseados:', servicios.length, servicios);

            if (servicios.length > 0) {
                // Si el servicio tiene monto 0, usar el monto de la factura
                servicios.forEach(s => {
                    if (s.unitario === 0 || s.total === 0) {
                        s.unitario = monto;
                        s.total = monto;
                    }
                });
                
                // Render table
                let rows = servicios.map(s => {
                    return `<tr>
                        <td>${escapeHtml(String(s.nombre || ''))}</td>
                        <td style="text-align:center;">${escapeHtml(String(s.cantidad || ''))}</td>
                        <td style="text-align:right;">${formatCurrencyCO(s.unitario)}</td>
                        <td style="text-align:right;">${formatCurrencyCO(s.total)}</td>
                    </tr>`;
                }).join('');

                servicesContainer.innerHTML = `
                    <div style="overflow:auto;">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Servicio</th>
                                    <th style="width:80px; text-align:center;">Cant.</th>
                                    <th style="width:140px; text-align:right;">Precio Unit.</th>
                                    <th style="width:140px; text-align:right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                // No services detected: show formatted raw text but intact
                const clean = String(desc)
                    .replace(/([A-Za-z\)])(\d)/g, "$1 $2")
                    .replace(/(\d)([A-Za-z])/g, "$1 $2")
                    .replace(/(\d{1,3}[\s\.,]\d{3}[\s\.,]\d{2})/g, "\n$1\n");

                servicesContainer.innerHTML = `
                    <div style="background:#f8f9fa; padding:12px; border-radius:6px; border:1px solid #e9ecef; max-height:420px; overflow:auto;">
                        <pre style="white-space:pre-wrap; margin:0; font-family:monospace; font-size:0.9rem; color:#333;">${escapeHtml(clean)}</pre>
                    </div>
                `;
            }

            document.getElementById('modalTotalAmount').textContent = '$' + formatCurrencyCO(monto);

            // show modal
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('serviceModal');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        // ---------- Events & init ----------
        document.addEventListener('DOMContentLoaded', function() {
            renderComparaciones(comparacionesData);
            setTimeout(initYearFilter, 50);

            document.getElementById('searchInput').addEventListener('input', filterCards);
            document.getElementById('yearFilter').addEventListener('change', filterCards);
            document.getElementById('statusFilter').addEventListener('change', filterCards);
            document.getElementById('clearFilters').addEventListener('click', clearAllFilters);

            // Delegated click to open modal
            document.addEventListener('click', function(e) {
                const invoiceItem = e.target.closest('.invoice-item');
                if (invoiceItem) {
                    try {
                        const raw = invoiceItem.getAttribute('data-factura');
                        const facturaData = JSON.parse(decodeURIComponent(raw));
                        openModal(facturaData);
                    } catch (err) {
                        console.error('Error al abrir modal:', err);
                    }
                }
            });

            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('serviceModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeModal();
            });
        });

        // ---------- Filtering helpers ----------
        function initYearFilter() {
            const years = new Set();
            const cards = document.querySelectorAll('#comparacionesContainer .card');
            cards.forEach(card => {
                const text = card.textContent;
                const m = text.match(/\b(20\d{2})\b/);
                if (m) years.add(m[1]);
            });
            const yearFilter = document.getElementById('yearFilter');
            Array.from(years).sort((a,b) => b - a).forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearFilter.appendChild(opt);
            });
        }

        function filterCards() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedStatus = document.getElementById('statusFilter').value;

            const cards = document.querySelectorAll('#comparacionesContainer .card');
            let visible = 0;
            cards.forEach(card => {
                let show = true;

                if (searchTerm) {
                    const serviceName = (card.querySelector('div[style*="font-weight:700"]')?.textContent || '').toLowerCase();
                    const invoiceNumbers = Array.from(card.querySelectorAll('.invoice-item .invoice-header .invoice-number') || []).map(el => el.textContent.toLowerCase()).join(' ');
                    show = serviceName.includes(searchTerm) || invoiceNumbers.includes(searchTerm);
                }

                if (show && selectedYear) {
                    show = card.textContent.includes(selectedYear);
                }

                if (show && selectedStatus) {
                    const badgeText = (card.querySelector('div[style*="padding:6px 10px"]')?.textContent || '').toLowerCase();
                    if (selectedStatus === 'subio') show = badgeText.includes('‚Üó');
                    if (selectedStatus === 'bajo') show = badgeText.includes('‚Üò');
                    if (selectedStatus === 'estable') show = badgeText.includes('‚Üí');
                }

                if (show) {
                    card.style.display = '';
                    visible++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('noResults').style.display = visible === 0 ? 'block' : 'none';
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.querySelectorAll('#comparacionesContainer .card').forEach(c => c.style.display = '');
            document.getElementById('noResults').style.display = 'none';
        }
    </script>
</body>
</html>
